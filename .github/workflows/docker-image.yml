name: Build and Deploy

on:
  push:
    branches: [ test ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    env:
      SSH_USER: ${{ secrets.SSH_USER }}
      SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
      SERVER_IP: ${{ secrets.SERVER_IP }}
      DEPLOY_PATH: /home/ubuntu/studentbar-pos-deploy
      ENV_PRODUCTION_FILE: ${{ secrets.ENV_PRODUCTION_FILE }}
      DOCKER_COMPOSE_FILE: docker-compose.prod.yaml

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'

      - name: Build backend
        working-directory: backend
        run: ./mvnw clean package -DskipTests

      - name: Set up Node 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install frontend dependencies
        working-directory: frontend
        run: npm ci

      - name: Build frontend
        working-directory: frontend
        run: npm run build

      - name: Set up SSH key
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" | tr -d '\r' > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan "$SERVER_IP" >> ~/.ssh/known_hosts
          
      - name: Debug CI SSH key fingerprint
        run: |
          set -e
          ssh-keygen -y -f ~/.ssh/id_rsa > /tmp/ci_key.pub
          echo "CI key fingerprint:"
          ssh-keygen -lf /tmp/ci_key.pub

      - name: Create .env.production from secret
        run: |
          printf '%s\n' "$ENV_PRODUCTION_FILE" > .env.production

      - name: Create deployment package
        run: |
          tar czf deployment.tar.gz \
            --exclude='frontend/node_modules' \
            --exclude='frontend/.git' \
            --exclude='frontend/.cache' \
            --exclude='frontend/.next/cache' \
            backend/target/*.jar \
            frontend/ \
            nginx/ \
            "$DOCKER_COMPOSE_FILE" \
            backend/Dockerfile \
            frontend/Dockerfile \
            .env.production
      - name: Debug package size
        run: |
          set -euxo pipefail
          ls -lh deployment.tar.gz
          du -sh frontend/node_modules || true
          du -sh frontend/dist || true
          du -sh backend/target || true

      - name: Install openssh-client
        run: |
          sudo apt-get update
          sudo apt-get install -y openssh-client
      - name: Copy deployment package to server (with integrity check)
        run: |
          set -euo pipefail
          TAR_NAME="deployment-${GITHUB_RUN_ID}.tar.gz"
          REMOTE_TMP="/tmp/${TAR_NAME}.part"
          REMOTE_FINAL="/tmp/${TAR_NAME}"
      
          LOCAL_SHA=$(sha256sum deployment.tar.gz | awk '{print $1}')
          LOCAL_SIZE=$(stat -c%s deployment.tar.gz)
          echo "Local size: ${LOCAL_SIZE} bytes"
          echo "Local sha256: ${LOCAL_SHA}"
      
          scp -C -i ~/.ssh/id_rsa \
            -o IdentitiesOnly=yes \
            -o BatchMode=yes \
            -o ConnectTimeout=20 \
            -o ServerAliveInterval=15 \
            -o ServerAliveCountMax=6 \
            -o StrictHostKeyChecking=yes \
            deployment.tar.gz \
            "$SSH_USER@$SERVER_IP:$REMOTE_TMP"
      
          REMOTE_SHA=$(ssh -i ~/.ssh/id_rsa \
            -o IdentitiesOnly=yes \
            -o BatchMode=yes \
            -o StrictHostKeyChecking=yes \
            "$SSH_USER@$SERVER_IP" "sha256sum '$REMOTE_TMP' | awk '{print \$1}'")
      
          if [ "$LOCAL_SHA" != "$REMOTE_SHA" ]; then
            echo "ERROR: checksum mismatch (upload incomplete/corrupt)"
            echo "LOCAL : $LOCAL_SHA"
            echo "REMOTE: $REMOTE_SHA"
            exit 1
          fi
      
          ssh -i ~/.ssh/id_rsa \
            -o IdentitiesOnly=yes \
            -o BatchMode=yes \
            -o StrictHostKeyChecking=yes \
            "$SSH_USER@$SERVER_IP" "mv '$REMOTE_TMP' '$REMOTE_FINAL' && ls -lh '$REMOTE_FINAL'"
           

      - name: Deploy on server
        run: |
          set -euxo pipefail
          TAR_NAME="deployment-${GITHUB_RUN_ID}.tar.gz"

          ssh -i ~/.ssh/id_rsa \
            -o IdentitiesOnly=yes \
            -o BatchMode=yes \
            -o ConnectTimeout=15 \
            -o StrictHostKeyChecking=yes \
            "$SSH_USER@$SERVER_IP" \
            "TAR_NAME='$TAR_NAME' DOCKER_COMPOSE_FILE='$DOCKER_COMPOSE_FILE' bash -se" << 'EOF'
          set -Eeuo pipefail

          DEPLOY_PATH="$HOME/studentbar-pos-deploy"

          echo "whoami: $(whoami)"
          echo "HOME: $HOME"
          echo "DEPLOY_PATH: $DEPLOY_PATH"
          echo "TAR: /tmp/$TAR_NAME"

          test -f "/tmp/$TAR_NAME"

          mkdir -p "$DEPLOY_PATH"
          tar xzf "/tmp/$TAR_NAME" -C "$DEPLOY_PATH"
          rm -f "/tmp/$TAR_NAME"

          cd "$DEPLOY_PATH"
          test -f "$DOCKER_COMPOSE_FILE"

          if [ -f .env.production ]; then
            cp .env.production .env
          fi

          docker compose -f "$DOCKER_COMPOSE_FILE" down || true
          docker compose -f "$DOCKER_COMPOSE_FILE" build --no-cache
          docker compose -f "$DOCKER_COMPOSE_FILE" up -d

          echo "Deployment complete!"
          docker compose -f "$DOCKER_COMPOSE_FILE" ps
          EOF
